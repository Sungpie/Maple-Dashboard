<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>메이플 원정대</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <h1>우리만의 메이플</h1>
    <hr />
    <div id="result"></div>

    <script>
      window.onload = function () {
        const characterNames = ["렌해바요", "옥길동렌", "렌깡떵", "랜선뽑은렌"];
        getAllCharacterInfo(characterNames);
      };

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // 비서(서버리스 함수)에게 정보를 요청하는 함수로 변경
      async function getCharacterInfo(characterName) {
        // 우리 서버의 '비서'에게 캐릭터 이름을 알려주며 요청
        const response = await fetch(
          `/api/get-character-info?characterName=${characterName}`
        );

        if (!response.ok) {
          // 요청 실패 시 에러 처리
          return { error: `'${characterName}' 님의 정보 조회에 실패했습니다.` };
        }
        return await response.json(); // 성공 시 모든 데이터(basic, stat, item)를 받음
      }

      async function getAllCharacterInfo(names) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML =
          "<p>캐릭터 정보를 안정적으로 불러오는 중입니다...</p>";

        const charactersData = [];

        for (const name of names) {
          await sleep(200); // 서버리스 함수는 더 빠르게 호출 가능
          const info = await getCharacterInfo(name);

          if (info.error) {
            console.error(info.error);
            continue;
          }

          if (info.basicData && info.basicData.character_name) {
            let combatPower = 0;
            if (info.statData && info.statData.final_stat) {
              const combatPowerStat = info.statData.final_stat.find(
                (stat) => stat.stat_name === "전투력"
              );
              if (combatPowerStat) {
                combatPower = parseInt(combatPowerStat.stat_value);
              }
            }
            charactersData.push({ ...info.basicData, combatPower });
          }
        }

        charactersData.sort((a, b) => b.combatPower - a.combatPower);

        let finalHtml = "";
        for (const char of charactersData) {
          finalHtml += `
              <a href="detail.html?characterName=${
                char.character_name
              }" style="text-decoration: none; color: inherit;">
                <div class="character-box">
                    <img src="${char.character_image}" alt="캐릭터 이미지">
                    <p><strong>캐릭터 이름:</strong> ${char.character_name}</p>
                    <p><strong>레벨:</strong> ${char.character_level} | ${
            char.character_class
          }</p>
                    <p><strong>서버:</strong> ${char.world_name}</p>
                    <p><strong>전투력:</strong> ${char.combatPower.toLocaleString()}</p>
                </div>
              </a>
            `;
        }
        resultDiv.innerHTML = finalHtml;
      }
    </script>
    <p class="notification">Data based on NEXON Open API</p>
  </body>
</html>
