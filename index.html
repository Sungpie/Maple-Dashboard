<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>메이플 원정대</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <h1>우리만의 메이플</h1>
    <hr />
    <div class="data-date-info" id="data-date-container"></div>
    <div id="result"></div>

    <script>
      window.onload = function () {
        const characterNames = ["렌해바요", "옥길동렌", "렌깡떵", "랜선뽑은렌"];
        getAllCharacterInfo(characterNames);
      };

      async function getCharacterInfo(characterName) {
        const cacheBuster = `&t=${new Date().getTime()}`;
        const response = await fetch(
          `/api/get-character-info?characterName=${encodeURIComponent(
            characterName
          )}${cacheBuster}`
        );
        if (!response.ok) {
          console.error(
            `[${characterName}] 정보 조회 실패:`,
            await response.text()
          );
          return { error: `'${characterName}' 님의 정보 조회에 실패했습니다.` };
        }
        return await response.json();
      }

      async function getAllCharacterInfo(names) {
        const resultDiv = document.getElementById("result");
        const dateContainer = document.getElementById("data-date-container");
        resultDiv.innerHTML =
          "<p>원정대원의 최신 정보를 불러오는 중입니다... 잠시만 기다려주세요!</p>";

        const charactersData = [];
        const promises = names.map((name) => getCharacterInfo(name));
        const results = await Promise.allSettled(promises);

        let latestDataDate = "";

        for (const result of results) {
          if (
            result.status === "fulfilled" &&
            result.value &&
            !result.value.error
          ) {
            const info = result.value;
            if (info.basicData && info.statData) {
              const currentCombatPowerStat = info.statData.final_stat?.find(
                (s) => s.stat_name === "전투력"
              );
              const currentCombatPower = currentCombatPowerStat
                ? parseInt(currentCombatPowerStat.stat_value, 10)
                : 0;

              const maxCombatPower = info.statData.max_combat_power || 0;

              charactersData.push({
                ...info.basicData,
                combatPower:
                  maxCombatPower > 0 ? maxCombatPower : currentCombatPower, // 최고 전투력 값을 사용, 없으면 현재 값
              });

              if (info.data_date) latestDataDate = info.data_date.split("T")[0];
            }
          } else {
            console.error(
              "캐릭터 정보 로딩 실패:",
              result.reason ||
                (result.value ? result.value.error : "알 수 없는 에러")
            );
          }
        }

        charactersData.sort((a, b) => b.combatPower - a.combatPower);

        if (latestDataDate) {
          dateContainer.innerText = `* 모든 정보는 ${latestDataDate} 이후 저장된 최신 데이터를 기준으로 합니다.`;
        }

        let finalHtml = "";
        if (charactersData.length === 0) {
          finalHtml =
            "<p>캐릭터 정보를 불러오지 못했습니다. API 키 또는 서버 상태를 확인해주세요.</p>";
        } else {
          for (const char of charactersData) {
            finalHtml += `
                  <a href="detail.html?characterName=${
                    char.character_name
                  }" style="text-decoration: none; color: inherit;">
                    <div class="character-box">
                        <img src="${char.character_image}" alt="${
              char.character_name
            } 이미지">
                        <p><strong>캐릭터 이름:</strong> ${
                          char.character_name
                        }</p>
                        <p><strong>레벨:</strong> ${char.character_level} | ${
              char.character_class
            }</p>
                        <p><strong>서버:</strong> ${char.world_name}</p>
                        <p><strong>전투력:</strong> ${char.combatPower.toLocaleString()}</p>
                    </div>
                  </a>
                `;
          }
        }

        resultDiv.innerHTML = finalHtml;
      }
    </script>
  </body>
</html>
