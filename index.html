<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>계남 메이플 원정대</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <h1>계남 메이플 원정대</h1>
    <hr />
    <div id="result"></div>

    <script src="config.js"></script>
    <script>
      window.onload = function () {
        const characterNames = ["렌해바요", "옥길동렌", "렌깡떵", "랜선뽑은렌"];
        getAllCharacterInfo(characterNames);
      };

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function getCharacterInfo(characterName, apiKey, date) {
        const myHeaders = new Headers();
        myHeaders.append("x-nxopen-api-key", apiKey);

        const ocidResponse = await fetch(
          `https://open.api.nexon.com/maplestory/v1/id?character_name=${characterName}`,
          {
            method: "GET",
            headers: myHeaders,
          }
        );
        const ocidData = await ocidResponse.json();
        const ocid = ocidData.ocid;

        if (!ocid) {
          return { error: `'${characterName}' 님을 찾을 수 없습니다.` };
        }

        const infoResponse = await fetch(
          `https://open.api.nexon.com/maplestory/v1/character/basic?ocid=${ocid}&date=${date}`,
          {
            method: "GET",
            headers: myHeaders,
          }
        );
        return await infoResponse.json();
      }

      async function getAllCharacterInfo(names) {
        const apiKey = API_KEY; // 본인의 API 키를 입력해주세요.
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML =
          "<p>캐릭터 정보를 안정적으로 불러오는 중입니다...</p>";

        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const dateString = yesterday.toISOString().split("T")[0];

        let finalHtml = "";

        for (const name of names) {
          await sleep(500);
          const infoData = await getCharacterInfo(name, apiKey, dateString);

          if (infoData.error) {
            finalHtml += `<p style="color: red;">${infoData.error}</p>`;
          } else {
            // ✨ 이 부분이 핵심적인 변경사항입니다!
            // 각 캐릭터 정보를 a 태그로 감싸고, 클릭 시 detail.html로 캐릭터 이름을 전달합니다.
            finalHtml += `
              <a href="detail.html?characterName=${infoData.character_name}" style="text-decoration: none; color: inherit;">
                <div class="character-box">
                    <img src="${infoData.character_image}" alt="캐릭터 이미지">
                    <p><strong>캐릭터 이름:</strong> ${infoData.character_name}</p>
                    <p><strong>레벨:</strong> ${infoData.character_level}</p>
                    <p><strong>직업:</strong> ${infoData.character_class}</p>
                    <p><strong>서버:</strong> ${infoData.world_name}</p>
                </div>
              </a>
            `;
          }
        }
        resultDiv.innerHTML = finalHtml;
      }
    </script>
  </body>
</html>
