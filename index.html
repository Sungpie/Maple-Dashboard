<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê³„ë‚¨ ë©”ì´í”Œ ì›ì •ëŒ€</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <h1>ê³„ë‚¨ ë©”ì´í”Œ ì›ì •ëŒ€</h1>
    <hr />
    <div id="result"></div>

    <script>
      window.onload = function () {
        const characterNames = ["ë Œí•´ë°”ìš”", "ì˜¥ê¸¸ë™ë Œ", "ë Œê¹¡ë–µ", "ëœì„ ë½‘ì€ë Œ"];
        getAllCharacterInfo(characterNames);
      };

      // ë”œë ˆì´ë¥¼ ìœ„í•œ í•¨ìˆ˜
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function getCharacterInfo(characterName, apiKey, date) {
        // 1. date íŒŒë¼ë¯¸í„° ì¶”ê°€
        const myHeaders = new Headers();
        myHeaders.append("x-nxopen-api-key", apiKey);

        const ocidResponse = await fetch(
          `https://open.api.nexon.com/maplestory/v1/id?character_name=${characterName}`,
          {
            method: "GET",
            headers: myHeaders,
          }
        );
        const ocidData = await ocidResponse.json();
        const ocid = ocidData.ocid;

        if (!ocid) {
          return { error: `'${characterName}' ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.` };
        }

        // 2. ê¸°ë³¸ ì •ë³´ ì¡°íšŒ ì‹œ date íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const infoResponse = await fetch(
          `https://open.api.nexon.com/maplestory/v1/character/basic?ocid=${ocid}&date=${date}`,
          {
            method: "GET",
            headers: myHeaders,
          }
        );
        return await infoResponse.json();
      }

      async function getAllCharacterInfo(names) {
        const apiKey = "api";
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML =
          "<p>ìºë¦­í„° ì •ë³´ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";

        // 3. ì–´ì œ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ êµ¬í•©ë‹ˆë‹¤. (APIëŠ” ì–´ì œ ë‚ ì§œ ê¸°ì¤€ ë°ì´í„°ë¥¼ ì œê³µ)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const dateString = yesterday.toISOString().split("T")[0];

        let finalHtml = "";

        for (const name of names) {
          // 4. ê° ìš”ì²­ ì „ì— 700ms(0.5ì´ˆ)ì”© ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
          await sleep(500);

          const infoData = await getCharacterInfo(name, apiKey, dateString); // dateString ì „ë‹¬

          if (infoData.error) {
            finalHtml += `<p style="color: red;">${infoData.error}</p>`;
          } else {
            // ğŸ‘‡ style="..."ì„ ì§€ìš°ê³  class="character-box"ë¥¼ ì¶”ê°€!
            finalHtml += `
        <div class="character-box">
            <img src="${infoData.character_image}" alt="ìºë¦­í„° ì´ë¯¸ì§€">
            <p><strong>ìºë¦­í„° ì´ë¦„:</strong> ${infoData.character_name}</p>
            <p><strong>ë ˆë²¨:</strong> ${infoData.character_level}</p>
            <p><strong>ì§ì—…:</strong> ${infoData.character_class}</p>
            <p><strong>ì„œë²„:</strong> ${infoData.world_name}</p>
        </div>
    `;
          }
        }
        resultDiv.innerHTML = finalHtml;
      }
    </script>
  </body>
</html>
