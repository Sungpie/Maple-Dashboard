<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>계남 메이플 원정대</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <h1>계남 메이플 원정대</h1>
    <hr />
    <div id="result"></div>

    <script>
      window.onload = function () {
        const characterNames = ["렌해바요", "옥길동렌", "렌깡떵", "랜선뽑은렌"];
        getAllCharacterInfo(characterNames);
      };

      // 딜레이를 위한 함수
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function getCharacterInfo(characterName, apiKey, date) {
        // 1. date 파라미터 추가
        const myHeaders = new Headers();
        myHeaders.append("x-nxopen-api-key", apiKey);

        const ocidResponse = await fetch(
          `https://open.api.nexon.com/maplestory/v1/id?character_name=${characterName}`,
          {
            method: "GET",
            headers: myHeaders,
          }
        );
        const ocidData = await ocidResponse.json();
        const ocid = ocidData.ocid;

        if (!ocid) {
          return { error: `'${characterName}' 님을 찾을 수 없습니다.` };
        }

        // 2. 기본 정보 조회 시 date 파라미터를 사용합니다.
        const infoResponse = await fetch(
          `https://open.api.nexon.com/maplestory/v1/character/basic?ocid=${ocid}&date=${date}`,
          {
            method: "GET",
            headers: myHeaders,
          }
        );
        return await infoResponse.json();
      }

      async function getAllCharacterInfo(names) {
        const apiKey = "api";
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML =
          "<p>캐릭터 정보를 안정적으로 불러오는 중입니다...</p>";

        // 3. 어제 날짜를 YYYY-MM-DD 형식으로 구합니다. (API는 어제 날짜 기준 데이터를 제공)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const dateString = yesterday.toISOString().split("T")[0];

        let finalHtml = "";

        for (const name of names) {
          // 4. 각 요청 전에 700ms(0.5초)씩 기다립니다.
          await sleep(500);

          const infoData = await getCharacterInfo(name, apiKey, dateString); // dateString 전달

          if (infoData.error) {
            finalHtml += `<p style="color: red;">${infoData.error}</p>`;
          } else {
            // 👇 style="..."을 지우고 class="character-box"를 추가!
            finalHtml += `
        <div class="character-box">
            <img src="${infoData.character_image}" alt="캐릭터 이미지">
            <p><strong>캐릭터 이름:</strong> ${infoData.character_name}</p>
            <p><strong>레벨:</strong> ${infoData.character_level}</p>
            <p><strong>직업:</strong> ${infoData.character_class}</p>
            <p><strong>서버:</strong> ${infoData.world_name}</p>
        </div>
    `;
          }
        }
        resultDiv.innerHTML = finalHtml;
      }
    </script>
  </body>
</html>
