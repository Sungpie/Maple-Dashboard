<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>캐릭터 상세 정보</title>
    <link rel="stylesheet" href="css/detail.css" />
  </head>
  <body>
    <div id="character-profile"></div>

    <div id="detail-result">
      <p>상세 정보를 불러오는 중입니다...</p>
    </div>

    <div
      id="item-tooltip"
      class="item-tooltip"
      style="visibility: hidden"
    ></div>

    <script>
      let characterItemData = null; // 아이템 정보를 캐시할 변수

      // 페이지가 로드되면 실행될 메인 함수
      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const characterName = urlParams.get("characterName");

        if (characterName) {
          document.title = `${characterName} - 상세 정보`;

          // 우리 서버의 '비서'에게 정보 요청
          const response = await fetch(
            `/api/get-character-info?characterName=${characterName}`
          );

          if (!response.ok) {
            document.getElementById(
              "detail-result"
            ).innerHTML = `<p style="color: red;">'${characterName}'님을 찾을 수 없습니다.</p>`;
            return;
          }

          const { basicData, statData, itemData } = await response.json();

          characterItemData = itemData;

          displayCharacterProfile(basicData, statData);
          displayCharacterDetails(itemData);
        } else {
          document.getElementById("detail-result").innerHTML =
            "<p>표시할 캐릭터 정보가 없습니다.</p>";
        }
      };

      // 캐릭터 프로필(상단)을 그리는 함수
      function displayCharacterProfile(basicData, statData) {
        const profileDiv = document.getElementById("character-profile");
        if (!basicData || !statData || !statData.final_stat) {
          profileDiv.innerHTML = "<p>캐릭터 정보를 불러오지 못했습니다.</p>";
          return;
        }

        const combatPowerStat = statData.final_stat.find(
          (stat) => stat.stat_name === "전투력"
        );
        const combatPower = combatPowerStat
          ? parseInt(combatPowerStat.stat_value).toLocaleString()
          : "정보 없음";

        // 홈 버튼을 포함한 프로필 HTML 생성
        let profileHtml = `
            <a href="index.html" class="home-button">🏠 홈으로</a>
            <div class="profile-image-container">
                <img src="${basicData.character_image}" alt="${basicData.character_name} 이미지" class="profile-image">
            </div>
            <div class="profile-info">
                <p class="profile-name">${basicData.character_name}</p>
                <p class="profile-level">Lv.${basicData.character_level} | ${basicData.character_class}</p>
                <p class="profile-power">전투력: ${combatPower}</p>
            </div>
            `;
        profileDiv.innerHTML = profileHtml;
      }

      // 장착 장비 그리드를 그리는 함수
      function displayCharacterDetails(itemData) {
        const resultDiv = document.getElementById("detail-result");
        let itemHtml = '<h2>장착 장비</h2><div class="item-grid">';
        if (itemData && itemData.item_equipment) {
          itemData.item_equipment.forEach((item) => {
            itemHtml += `
                <div class="item-box" data-item-name="${item.item_name}">
                    <img src="${item.item_icon}" alt="${item.item_name}">
                    <p>${item.item_name}</p>
                </div>
                `;
          });
        } else {
          itemHtml += "<p>장비 정보를 불러오지 못했습니다.</p>";
        }
        itemHtml += "</div>";
        resultDiv.innerHTML = itemHtml;

        attachItemHoverListeners(); // 아이템에 마우스 이벤트 추가
      }

      // 모든 아이템 박스에 마우스 이벤트를 등록하는 함수
      function attachItemHoverListeners() {
        document.querySelectorAll(".item-box").forEach((box) => {
          box.addEventListener("mouseenter", handleMouseEnter);
          box.addEventListener("mouseleave", handleMouseLeave);
        });
      }

      // 아이템 상세 정보 툴팁을 생성하고 표시하는 함수
      async function handleMouseEnter(event) {
        const itemBox = event.currentTarget;
        const itemName = itemBox.dataset.itemName;
        const tooltip = document.getElementById("item-tooltip");

        const itemDetail = characterItemData.item_equipment.find(
          (item) => item.item_name === itemName
        );

        if (itemDetail) {
          let detailHtml = "";
          const starforce = parseInt(itemDetail.starforce) || 0;
          if (starforce > 0) {
            let stars = "";
            for (let i = 1; i <= 25; i++) {
              stars += i <= starforce ? "★" : "☆";
              if (i === 10 || i === 20) stars += "<br>";
            }
            detailHtml += `<p class="starforce">${stars}</p>`;
          }

          detailHtml += `<p class="item-name">${itemDetail.item_name} (+${
            itemDetail.scroll_upgrade || 0
          })</p>`;
          if (itemDetail.potential_option_grade) {
            detailHtml += `<p class="item-grade">(${itemDetail.potential_option_grade} 아이템)</p>`;
          }
          detailHtml += `<hr>`;
          detailHtml += `<div class="item-icon-container"><img src="${itemDetail.item_icon}" alt="${itemDetail.item_name}"></div>`;
          detailHtml += `<p>장비분류 : ${itemDetail.item_equipment_slot}</p>`;

          const base = itemDetail.item_base_option || {};
          const add = itemDetail.item_add_option || {};
          const star = itemDetail.item_starforce_option || {};
          const flame = itemDetail.item_flame_option || {};
          const etc = itemDetail.item_etc_option || {};

          // 스탯을 분석하여 색상과 함께 HTML로 만들어주는 만능 함수
          const formatStat = (
            name,
            baseVal,
            addVal,
            starVal,
            flameVal,
            etcVal,
            isPercentage = false
          ) => {
            const base = parseInt(baseVal) || 0;
            const add = parseInt(addVal) || 0;
            const star = parseInt(starVal) || 0;
            const flame = parseInt(flameVal) || 0;
            const etc = parseInt(etcVal) || 0;

            const total = base + add + star + flame + etc;
            if (total === 0) return "";

            let detail = `${name} : +${total}${isPercentage ? "%" : ""}`;

            if (add > 0 || star > 0 || flame > 0 || etc > 0) {
              let breakdown = ` (${base}${isPercentage ? "%" : ""}`;
              if (add > 0)
                breakdown += `<span class="add-opt"> +${add}${
                  isPercentage ? "%" : ""
                }</span>`;
              if (star > 0)
                breakdown += `<span class="star-opt"> +${star}${
                  isPercentage ? "%" : ""
                }</span>`;
              if (flame > 0)
                breakdown += `<span class="flame-opt"> +${flame}${
                  isPercentage ? "%" : ""
                }</span>`;
              if (etc > 0)
                breakdown += `<span class="etc-opt"> +${etc}${
                  isPercentage ? "%" : ""
                }</span>`;
              breakdown += `)`;
              detail += breakdown;
            }
            return `<p>${detail}</p>`;
          };

          detailHtml += formatStat(
            "STR",
            base.str,
            add.str,
            star.str,
            flame.str,
            etc.str
          );
          detailHtml += formatStat(
            "DEX",
            base.dex,
            add.dex,
            star.dex,
            flame.dex,
            etc.dex
          );
          detailHtml += formatStat(
            "INT",
            base.int,
            add.int,
            star.int,
            flame.int,
            etc.int
          );
          detailHtml += formatStat(
            "LUK",
            base.luk,
            add.luk,
            star.luk,
            flame.luk,
            etc.luk
          );
          detailHtml += formatStat(
            "최대 HP",
            base.max_hp,
            add.max_hp,
            star.max_hp,
            flame.max_hp,
            etc.max_hp
          );
          detailHtml += formatStat(
            "공격력",
            base.attack_power,
            add.attack_power,
            star.attack_power,
            flame.attack_power,
            etc.attack_power
          );
          detailHtml += formatStat(
            "마력",
            base.magic_power,
            add.magic_power,
            star.magic_power,
            flame.magic_power,
            etc.magic_power
          );
          detailHtml += formatStat(
            "방어력",
            base.armor,
            add.armor,
            star.armor,
            flame.armor,
            etc.armor
          );

          // 퍼센트(%) 스탯들도 formatStat 함수를 사용하도록 통일
          detailHtml += formatStat(
            "올스탯",
            base.all_stat,
            add.all_stat,
            null,
            flame.all_stat,
            null,
            true
          );
          detailHtml += formatStat(
            "보스 몬스터 공격 시 데미지",
            base.boss_damage,
            add.boss_damage,
            null,
            flame.boss_damage,
            null,
            true
          );
          detailHtml += formatStat(
            "몬스터 방어율 무시",
            base.ignore_monster_armor,
            add.ignore_monster_armor,
            star.ignore_monster_armor,
            null,
            null,
            true
          );

          // 잠재능력 표시
          if (
            itemDetail.potential_option_grade &&
            itemDetail.potential_option_grade !== "노멀"
          ) {
            const grade = itemDetail.potential_option_grade.toLowerCase();
            detailHtml += `<hr><p><span class="potential-prefix ${grade}">${grade
              .charAt(0)
              .toUpperCase()}</span><span class="potential-text ${grade}"> 잠재옵션</span></p>`;
            if (itemDetail.potential_option_1)
              detailHtml += `<p>${itemDetail.potential_option_1}</p>`;
            if (itemDetail.potential_option_2)
              detailHtml += `<p>${itemDetail.potential_option_2}</p>`;
            if (itemDetail.potential_option_3)
              detailHtml += `<p>${itemDetail.potential_option_3}</p>`;
          }

          // 에디셔널 잠재능력 표시
          if (
            itemDetail.additional_potential_option_grade &&
            itemDetail.additional_potential_option_grade !== "노멀"
          ) {
            const grade =
              itemDetail.additional_potential_option_grade.toLowerCase();
            detailHtml += `<hr><p><span class="potential-prefix ${grade}">${grade
              .charAt(0)
              .toUpperCase()}</span><span class="potential-text ${grade}"> 에디셔널 잠재옵션</span></p>`;
            if (itemDetail.additional_potential_option_1)
              detailHtml += `<p>${itemDetail.additional_potential_option_1}</p>`;
            if (itemDetail.additional_potential_option_2)
              detailHtml += `<p>${itemDetail.additional_potential_option_2}</p>`;
            if (itemDetail.additional_potential_option_3)
              detailHtml += `<p>${itemDetail.additional_potential_option_3}</p>`;
          }
          tooltip.innerHTML = detailHtml;
        } else {
          tooltip.innerHTML = `<p><strong>${itemName}</strong></p><p>상세 정보를 찾을 수 없습니다.</p>`;
        }

        tooltip.style.visibility = "visible";
        tooltip.style.opacity = "1";
        const boxRect = itemBox.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        let left =
          boxRect.left +
          window.scrollX +
          boxRect.width / 2 -
          tooltipRect.width / 2;
        if (left + tooltipRect.width > window.innerWidth)
          left = window.innerWidth - tooltipRect.width - 20;
        if (left < 0) left = 20;
        tooltip.style.left = `${left}px`;
        let top = boxRect.top + window.scrollY - tooltipRect.height - 10;
        if (top < window.scrollY) top = boxRect.bottom + window.scrollY + 10;
        tooltip.style.top = `${top}px`;
      }

      // 마우스가 아이템에서 벗어났을 때 툴팁을 숨기는 함수
      function handleMouseLeave() {
        const tooltip = document.getElementById("item-tooltip");
        tooltip.style.visibility = "hidden";
        tooltip.style.opacity = "0";
      }
    </script>
    <p class="notification">Data based on NEXON Open API</p>
  </body>
</html>
