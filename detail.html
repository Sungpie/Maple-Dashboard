<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ìºë¦­í„° ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="css/detail.css" />
  </head>
  <body>
    <div id="character-profile"></div>

    <div id="detail-result">
      <p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div
      id="item-tooltip"
      class="item-tooltip"
      style="visibility: hidden"
    ></div>

    <script>
      let characterItemData = null; // ì•„ì´í…œ ì •ë³´ë¥¼ ìºì‹œí•  ë³€ìˆ˜

      // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹¤í–‰ë  ë©”ì¸ í•¨ìˆ˜
      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const characterName = urlParams.get("characterName");

        if (characterName) {
          document.title = `${characterName} - ìƒì„¸ ì •ë³´`;

          // ìš°ë¦¬ ì„œë²„ì˜ 'ë¹„ì„œ'ì—ê²Œ ì •ë³´ ìš”ì²­
          const response = await fetch(
            `/api/get-character-info?characterName=${characterName}`
          );

          if (!response.ok) {
            document.getElementById(
              "detail-result"
            ).innerHTML = `<p style="color: red;">'${characterName}'ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
          }

          const { basicData, statData, itemData } = await response.json();

          characterItemData = itemData;

          displayCharacterProfile(basicData, statData);
          displayCharacterDetails(itemData);
        } else {
          document.getElementById("detail-result").innerHTML =
            "<p>í‘œì‹œí•  ìºë¦­í„° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
      };

      // ìºë¦­í„° í”„ë¡œí•„(ìƒë‹¨)ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
      function displayCharacterProfile(basicData, statData) {
        const profileDiv = document.getElementById("character-profile");
        if (!basicData || !statData || !statData.final_stat) {
          profileDiv.innerHTML = "<p>ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
          return;
        }

        const combatPowerStat = statData.final_stat.find(
          (stat) => stat.stat_name === "ì „íˆ¬ë ¥"
        );
        const combatPower = combatPowerStat
          ? parseInt(combatPowerStat.stat_value).toLocaleString()
          : "ì •ë³´ ì—†ìŒ";

        // í™ˆ ë²„íŠ¼ì„ í¬í•¨í•œ í”„ë¡œí•„ HTML ìƒì„±
        let profileHtml = `
            <a href="index.html" class="home-button">ğŸ  í™ˆìœ¼ë¡œ</a>
            <div class="profile-image-container">
                <img src="${basicData.character_image}" alt="${basicData.character_name} ì´ë¯¸ì§€" class="profile-image">
            </div>
            <div class="profile-info">
                <p class="profile-name">${basicData.character_name}</p>
                <p class="profile-level">Lv.${basicData.character_level} | ${basicData.character_class}</p>
                <p class="profile-power">ì „íˆ¬ë ¥: ${combatPower}</p>
            </div>
            `;
        profileDiv.innerHTML = profileHtml;
      }

      // ì¥ì°© ì¥ë¹„ ê·¸ë¦¬ë“œë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
      function displayCharacterDetails(itemData) {
        const resultDiv = document.getElementById("detail-result");
        let itemHtml = '<h2>ì¥ì°© ì¥ë¹„</h2><div class="item-grid">';
        if (itemData && itemData.item_equipment) {
          itemData.item_equipment.forEach((item) => {
            itemHtml += `
                <div class="item-box" data-item-name="${item.item_name}">
                    <img src="${item.item_icon}" alt="${item.item_name}">
                    <p>${item.item_name}</p>
                </div>
                `;
          });
        } else {
          itemHtml += "<p>ì¥ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        }
        itemHtml += "</div>";
        resultDiv.innerHTML = itemHtml;

        attachItemHoverListeners(); // ì•„ì´í…œì— ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
      }

      // ëª¨ë“  ì•„ì´í…œ ë°•ìŠ¤ì— ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•˜ëŠ” í•¨ìˆ˜
      function attachItemHoverListeners() {
        document.querySelectorAll(".item-box").forEach((box) => {
          box.addEventListener("mouseenter", handleMouseEnter);
          box.addEventListener("mouseleave", handleMouseLeave);
        });
      }

      // ì•„ì´í…œ ìƒì„¸ ì •ë³´ íˆ´íŒì„ ìƒì„±í•˜ê³  í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
      async function handleMouseEnter(event) {
        const itemBox = event.currentTarget;
        const itemName = itemBox.dataset.itemName;
        const tooltip = document.getElementById("item-tooltip");

        const itemDetail = characterItemData.item_equipment.find(
          (item) => item.item_name === itemName
        );

        if (itemDetail) {
          let detailHtml = "";
          const starforce = parseInt(itemDetail.starforce) || 0;
          if (starforce > 0) {
            let stars = "";
            for (let i = 1; i <= 25; i++) {
              stars += i <= starforce ? "â˜…" : "â˜†";
              if (i === 10 || i === 20) stars += "<br>";
            }
            detailHtml += `<p class="starforce">${stars}</p>`;
          }

          detailHtml += `<p class="item-name">${itemDetail.item_name} (+${
            itemDetail.scroll_upgrade || 0
          })</p>`;
          if (itemDetail.potential_option_grade) {
            detailHtml += `<p class="item-grade">(${itemDetail.potential_option_grade} ì•„ì´í…œ)</p>`;
          }
          detailHtml += `<hr>`;
          detailHtml += `<div class="item-icon-container"><img src="${itemDetail.item_icon}" alt="${itemDetail.item_name}"></div>`;
          detailHtml += `<p>ì¥ë¹„ë¶„ë¥˜ : ${itemDetail.item_equipment_slot}</p>`;

          const base = itemDetail.item_base_option || {};
          const add = itemDetail.item_add_option || {};
          const star = itemDetail.item_starforce_option || {};
          const flame = itemDetail.item_flame_option || {};
          const etc = itemDetail.item_etc_option || {};

          // ìŠ¤íƒ¯ì„ ë¶„ì„í•˜ì—¬ ìƒ‰ìƒê³¼ í•¨ê»˜ HTMLë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ë§ŒëŠ¥ í•¨ìˆ˜
          const formatStat = (
            name,
            baseVal,
            addVal,
            starVal,
            flameVal,
            etcVal,
            isPercentage = false
          ) => {
            const base = parseInt(baseVal) || 0;
            const add = parseInt(addVal) || 0;
            const star = parseInt(starVal) || 0;
            const flame = parseInt(flameVal) || 0;
            const etc = parseInt(etcVal) || 0;

            const total = base + add + star + flame + etc;
            if (total === 0) return "";

            let detail = `${name} : +${total}${isPercentage ? "%" : ""}`;

            if (add > 0 || star > 0 || flame > 0 || etc > 0) {
              let breakdown = ` (${base}${isPercentage ? "%" : ""}`;
              if (add > 0)
                breakdown += `<span class="add-opt"> +${add}${
                  isPercentage ? "%" : ""
                }</span>`;
              if (star > 0)
                breakdown += `<span class="star-opt"> +${star}${
                  isPercentage ? "%" : ""
                }</span>`;
              if (flame > 0)
                breakdown += `<span class="flame-opt"> +${flame}${
                  isPercentage ? "%" : ""
                }</span>`;
              if (etc > 0)
                breakdown += `<span class="etc-opt"> +${etc}${
                  isPercentage ? "%" : ""
                }</span>`;
              breakdown += `)`;
              detail += breakdown;
            }
            return `<p>${detail}</p>`;
          };

          detailHtml += formatStat(
            "STR",
            base.str,
            add.str,
            star.str,
            flame.str,
            etc.str
          );
          detailHtml += formatStat(
            "DEX",
            base.dex,
            add.dex,
            star.dex,
            flame.dex,
            etc.dex
          );
          detailHtml += formatStat(
            "INT",
            base.int,
            add.int,
            star.int,
            flame.int,
            etc.int
          );
          detailHtml += formatStat(
            "LUK",
            base.luk,
            add.luk,
            star.luk,
            flame.luk,
            etc.luk
          );
          detailHtml += formatStat(
            "ìµœëŒ€ HP",
            base.max_hp,
            add.max_hp,
            star.max_hp,
            flame.max_hp,
            etc.max_hp
          );
          detailHtml += formatStat(
            "ê³µê²©ë ¥",
            base.attack_power,
            add.attack_power,
            star.attack_power,
            flame.attack_power,
            etc.attack_power
          );
          detailHtml += formatStat(
            "ë§ˆë ¥",
            base.magic_power,
            add.magic_power,
            star.magic_power,
            flame.magic_power,
            etc.magic_power
          );
          detailHtml += formatStat(
            "ë°©ì–´ë ¥",
            base.armor,
            add.armor,
            star.armor,
            flame.armor,
            etc.armor
          );

          // í¼ì„¼íŠ¸(%) ìŠ¤íƒ¯ë“¤ë„ formatStat í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í†µì¼
          detailHtml += formatStat(
            "ì˜¬ìŠ¤íƒ¯",
            base.all_stat,
            add.all_stat,
            null,
            flame.all_stat,
            null,
            true
          );
          detailHtml += formatStat(
            "ë³´ìŠ¤ ëª¬ìŠ¤í„° ê³µê²© ì‹œ ë°ë¯¸ì§€",
            base.boss_damage,
            add.boss_damage,
            null,
            flame.boss_damage,
            null,
            true
          );
          detailHtml += formatStat(
            "ëª¬ìŠ¤í„° ë°©ì–´ìœ¨ ë¬´ì‹œ",
            base.ignore_monster_armor,
            add.ignore_monster_armor,
            star.ignore_monster_armor,
            null,
            null,
            true
          );

          // ì ì¬ëŠ¥ë ¥ í‘œì‹œ
          if (
            itemDetail.potential_option_grade &&
            itemDetail.potential_option_grade !== "ë…¸ë©€"
          ) {
            const grade = itemDetail.potential_option_grade.toLowerCase();
            detailHtml += `<hr><p><span class="potential-prefix ${grade}">${grade
              .charAt(0)
              .toUpperCase()}</span><span class="potential-text ${grade}"> ì ì¬ì˜µì…˜</span></p>`;
            if (itemDetail.potential_option_1)
              detailHtml += `<p>${itemDetail.potential_option_1}</p>`;
            if (itemDetail.potential_option_2)
              detailHtml += `<p>${itemDetail.potential_option_2}</p>`;
            if (itemDetail.potential_option_3)
              detailHtml += `<p>${itemDetail.potential_option_3}</p>`;
          }

          // ì—ë””ì…”ë„ ì ì¬ëŠ¥ë ¥ í‘œì‹œ
          if (
            itemDetail.additional_potential_option_grade &&
            itemDetail.additional_potential_option_grade !== "ë…¸ë©€"
          ) {
            const grade =
              itemDetail.additional_potential_option_grade.toLowerCase();
            detailHtml += `<hr><p><span class="potential-prefix ${grade}">${grade
              .charAt(0)
              .toUpperCase()}</span><span class="potential-text ${grade}"> ì—ë””ì…”ë„ ì ì¬ì˜µì…˜</span></p>`;
            if (itemDetail.additional_potential_option_1)
              detailHtml += `<p>${itemDetail.additional_potential_option_1}</p>`;
            if (itemDetail.additional_potential_option_2)
              detailHtml += `<p>${itemDetail.additional_potential_option_2}</p>`;
            if (itemDetail.additional_potential_option_3)
              detailHtml += `<p>${itemDetail.additional_potential_option_3}</p>`;
          }
          tooltip.innerHTML = detailHtml;
        } else {
          tooltip.innerHTML = `<p><strong>${itemName}</strong></p><p>ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }

        tooltip.style.visibility = "visible";
        tooltip.style.opacity = "1";
        const boxRect = itemBox.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        let left =
          boxRect.left +
          window.scrollX +
          boxRect.width / 2 -
          tooltipRect.width / 2;
        if (left + tooltipRect.width > window.innerWidth)
          left = window.innerWidth - tooltipRect.width - 20;
        if (left < 0) left = 20;
        tooltip.style.left = `${left}px`;
        let top = boxRect.top + window.scrollY - tooltipRect.height - 10;
        if (top < window.scrollY) top = boxRect.bottom + window.scrollY + 10;
        tooltip.style.top = `${top}px`;
      }

      // ë§ˆìš°ìŠ¤ê°€ ì•„ì´í…œì—ì„œ ë²—ì–´ë‚¬ì„ ë•Œ íˆ´íŒì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
      function handleMouseLeave() {
        const tooltip = document.getElementById("item-tooltip");
        tooltip.style.visibility = "hidden";
        tooltip.style.opacity = "0";
      }
    </script>
    <p class="notification">Data based on NEXON Open API</p>
  </body>
</html>
