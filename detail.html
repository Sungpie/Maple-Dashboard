<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ìºë¦­í„° ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="css/detail.css" />
  </head>
  <body>
    <div id="character-profile"></div>
    <div id="detail-result">
      <p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
    <div
      id="item-tooltip"
      class="item-tooltip"
      style="visibility: hidden"
    ></div>

    <script>
      let characterItemData = null;

      // âœ¨ [í•µì‹¬ ìˆ˜ì •] window.onload ë¡œì§ì„ ëª…í™•í•˜ê²Œ ìˆ˜ì •
      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const characterName = urlParams.get("characterName");

        // 'ë¹„ì„œ'ì—ê²Œ ì •ë³´ ìš”ì²­
        const response = await fetch(
          `/api/get-character-info?characterName=${encodeURIComponent(
            characterName
          )}`
        );
        if (!response.ok) {
          document.getElementById(
            "detail-result"
          ).innerHTML = `<p style="color: red;">'${characterName}' ë‹˜ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        const info = await response.json();
        if (info.error) {
          document.getElementById(
            "detail-result"
          ).innerHTML = `<p style="color: red;">${info.error}</p>`;
          return;
        }

        const { basicData, statData, itemData } = info;

        if (!basicData) {
          document.getElementById(
            "detail-result"
          ).innerHTML = `<p style="color: red;">ìºë¦­í„° ê¸°ë³¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        document.title = `${basicData.character_name} - ìƒì„¸ ì •ë³´`;

        // íˆ´íŒì´ ì‚¬ìš©í•  ì „ì²´ ì•„ì´í…œ ëª©ë¡ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        characterItemData = itemData;

        // í™”ë©´ì— í”„ë¡œí•„ê³¼ ì•„ì´í…œ ëª©ë¡ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
        displayCharacterProfile(basicData, statData);
        displayCharacterDetails(itemData); // âœ¨ ì´ì œ itemDataëŠ” ëª¨ë“  ì•„ì´í…œì´ ë‹´ê¸´ ê°ì²´ì…ë‹ˆë‹¤.
      };

      function displayCharacterProfile(basicData, statData) {
        const profileDiv = document.getElementById("character-profile");
        const combatPowerStat = statData?.final_stat?.find(
          (stat) => stat.stat_name === "ì „íˆ¬ë ¥"
        );
        const combatPower = combatPowerStat
          ? parseInt(combatPowerStat.stat_value).toLocaleString()
          : "ì •ë³´ ì—†ìŒ";

        let profileHtml = `
            <a href="index.html" class="home-button">ğŸ  í™ˆìœ¼ë¡œ</a>
            <div class="profile-image-container">
                <img src="${basicData.character_image}" alt="${basicData.character_name} ì´ë¯¸ì§€" class="profile-image">
            </div>
            <div class="profile-info">
                <p class="profile-name">${basicData.character_name}</p>
                <p class="profile-level">Lv.${basicData.character_level} | ${basicData.character_class}</p>
                <p class="profile-power">ì „íˆ¬ë ¥: ${combatPower}</p>
            </div>
            `;
        profileDiv.innerHTML = profileHtml;
      }

      function displayCharacterDetails(itemData) {
        const resultDiv = document.getElementById("detail-result");
        let itemHtml =
          '<h2>ì¥ì°© ì¥ë¹„ (ëª¨ë“  í”„ë¦¬ì…‹)</h2><div class="item-grid">';

        // âœ¨ itemDataì™€ ê·¸ ì•ˆì˜ item_equipmentê°€ ìœ íš¨í•œì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
        if (
          itemData &&
          itemData.item_equipment &&
          itemData.item_equipment.length > 0
        ) {
          itemData.item_equipment.forEach((item) => {
            itemHtml += `
                <div class="item-box" data-item-name="${item.item_name}">
                    <img src="${item.item_icon}" alt="${item.item_name}">
                    <p>${item.item_name}</p>
                </div>
                `;
          });
        } else {
          itemHtml += "<p>ì¥ì°©í•œ ì¥ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        }
        itemHtml += "</div>";
        resultDiv.innerHTML = itemHtml;

        attachItemHoverListeners();
      }

      function attachItemHoverListeners() {
        document.querySelectorAll(".item-box").forEach((box) => {
          box.addEventListener("mouseenter", handleMouseEnter);
          box.addEventListener("mouseleave", handleMouseLeave);
        });
      }

      // handleMouseEnter, handleMouseLeave í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
      // ... (ì´í•˜ ìƒëµ)
    </script>
  </body>
</html>
